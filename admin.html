<!DOCTYPE html> 
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Painel Administrativo - Vota√ß√£o de Apresenta√ß√µes</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap');

    body {
      font-family: 'Orbitron', sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #fff;
      text-shadow: 1px 1px 2px #000;
      min-height: 100vh;
    }

    h1, h2 {
      text-align: center;
      color: #ffcc00;
      margin-bottom: 30px;
    }

    .admin-container {
      max-width: 800px;
      margin: 0 auto;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
    }

    .status-panel {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 2px solid #ffcc00;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
    }

    .status-label {
      font-weight: bold;
      color: #ffcc00;
    }

    .status-value {
      color: #fff;
    }

    .votos-panel {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }

    .voto-item {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 15px;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      border-left: 4px solid #00aaff;
    }

    .grupo-nome {
      font-weight: bold;
      font-size: 18px;
    }

    .voto-count {
      background-color: #ffcc00;
      color: #000;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 16px;
    }

    .apresentados-panel {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }

    .apresentado-item {
      padding: 10px;
      margin: 5px 0;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      border-left: 4px solid #4CAF50;
    }

    button {
      margin: 10px;
      padding: 15px 25px;
      font-size: 18px;
      font-weight: bold;
      background-color: #00aaff;
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      box-shadow: 2px 2px 6px #000;
      transition: all 0.3s ease;
      width: 100%;
      max-width: 300px;
    }

    button:hover {
      background-color: #0088cc;
      transform: scale(1.05);
    }

    button:disabled {
      background-color: #666;
      cursor: not-allowed;
      transform: none;
    }

    .btn-danger {
      background-color: #f44336;
    }

    .btn-danger:hover {
      background-color: #d32f2f;
    }

    .btn-success {
      background-color: #4CAF50;
    }

    .btn-success:hover {
      background-color: #45a049;
    }

    .btn-warning {
      background-color: #ff9800;
    }

    .btn-warning:hover {
      background-color: #e68900;
    }

    .actions-panel {
      text-align: center;
      margin-top: 30px;
    }

    #status-conexao {
      position: fixed;
      top: 15px;
      right: 15px;
      padding: 10px 15px;
      border-radius: 5px;
      font-weight: bold;
      z-index: 1000;
    }

    .conectado {
      background-color: #4CAF50;
      color: white;
    }

    .desconectado {
      background-color: #f44336;
      color: white;
    }

    .loading {
      text-align: center;
      font-size: 20px;
      color: #ffcc00;
    }
  </style>
</head>
<body>

<div id="status-conexao" class="desconectado">üî¥ Desconectado</div>

<div class="admin-container">
  <h1>üé≠ Painel Administrativo</h1>
  <h2>Sistema de Vota√ß√£o de Apresenta√ß√µes</h2>

  <div class="status-panel">
    <h3>üìä Status da Vota√ß√£o</h3>
    <div class="status-item">
      <span class="status-label">Estado:</span>
      <span class="status-value" id="estado-votacao">Carregando...</span>
    </div>
    <div class="status-item">
      <span class="status-label">Rodada Atual:</span>
      <span class="status-value" id="rodada-atual">-</span>
    </div>
    <div class="status-item">
      <span class="status-label">Total de Votos:</span>
      <span class="status-value" id="total-votos">0</span>
    </div>
    <div class="status-item">
      <span class="status-label">Grupos Restantes:</span>
      <span class="status-value" id="grupos-restantes">-</span>
    </div>
  </div>

  <div class="votos-panel">
    <h3>üó≥Ô∏è Votos da Rodada Atual</h3>
    <div id="votos-container" class="loading">Carregando votos...</div>
  </div>

  <div class="apresentados-panel">
    <h3>üìã Grupos J√° Apresentados</h3>
    <div id="apresentados-container">
      <p>Nenhum grupo apresentado ainda.</p>
    </div>
  </div>

  <div class="actions-panel">
    <button id="btn-encerrar" class="btn-danger" onclick="encerrarRodada()">
      ‚úÖ Encerrar Vota√ß√£o da Rodada
    </button>
    <br>
    <button id="btn-reiniciar" class="btn-warning" onclick="reiniciarVotacao()">
      üîÑ Reiniciar Vota√ß√£o Completa
    </button>
    <br>
    <button id="btn-voltar" class="btn-success" onclick="window.open('/', '_blank')">
      üì± Abrir P√°gina de Vota√ß√£o
    </button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  // Configura√ß√£o do Socket.IO
  const socket = io();
  
  // Elementos do DOM
  const statusConexao = document.getElementById('status-conexao');
  const estadoVotacao = document.getElementById('estado-votacao');
  const rodadaAtual = document.getElementById('rodada-atual');
  const totalVotos = document.getElementById('total-votos');
  const gruposRestantes = document.getElementById('grupos-restantes');
  const votosContainer = document.getElementById('votos-container');
  const apresentadosContainer = document.getElementById('apresentados-container');
  const btnEncerrar = document.getElementById('btn-encerrar');
  const btnReiniciar = document.getElementById('btn-reiniciar');

  let estadoAtual = null;

  // Fun√ß√µes de utilidade
  function mostrarAlerta(mensagem, tipo = 'success') {
    let backgroundColor, icon;
    
    switch(tipo) {
      case 'success':
        backgroundColor = "#4CAF50";
        icon = "‚úÖ";
        break;
      case 'error':
        backgroundColor = "#f44336";
        icon = "‚ùå";
        break;
      case 'warning':
        backgroundColor = "#FF9800";
        icon = "‚ö†Ô∏è";
        break;
      default:
        backgroundColor = "#2196F3";
        icon = "‚ÑπÔ∏è";
    }
    
    Toastify({
      text: `${icon} ${mensagem}`,
      duration: 5000,
      gravity: "top",
      position: "center",
      backgroundColor: backgroundColor,
      color: "#fff",
      fontSize: "16px",
      fontFamily: "'Orbitron', sans-serif",
      stopOnFocus: true,
      close: true
    }).showToast();
  }

  function atualizarInterface(estado) {
    estadoAtual = estado;
    
    // Status da vota√ß√£o
    estadoVotacao.textContent = estado.votacaoAtiva ? 'üü¢ Ativa' : 'üî¥ Encerrada';
    rodadaAtual.textContent = estado.rodadaAtual;
    totalVotos.textContent = estado.totalVotos;
    
    const restantes = estado.grupos.filter(g => !estado.apresentados.includes(g));
    gruposRestantes.textContent = restantes.length;
    
    // Votos da rodada atual
    if (estado.votacaoAtiva && restantes.length > 1) {
      votosContainer.innerHTML = '';
      restantes.forEach(grupo => {
        const votoItem = document.createElement('div');
        votoItem.className = 'voto-item';
        votoItem.innerHTML = `
          <span class="grupo-nome">${grupo}</span>
          <span class="voto-count">${estado.votos[grupo] || 0} votos</span>
        `;
        votosContainer.appendChild(votoItem);
      });
    } else if (restantes.length === 1) {
      votosContainer.innerHTML = `<p><strong>√öltimo grupo: ${restantes[0]}</strong></p>`;
    } else {
      votosContainer.innerHTML = '<p>Nenhum grupo restante para votar.</p>';
    }
    
    // Grupos j√° apresentados
    if (estado.apresentados.length > 0) {
      apresentadosContainer.innerHTML = '';
      estado.apresentados.forEach((grupo, index) => {
        const apresentadoItem = document.createElement('div');
        apresentadoItem.className = 'apresentado-item';
        apresentadoItem.innerHTML = `<strong>${index + 1}¬∫</strong> - ${grupo}`;
        apresentadosContainer.appendChild(apresentadoItem);
      });
    } else {
      apresentadosContainer.innerHTML = '<p>Nenhum grupo apresentado ainda.</p>';
    }
    
    // Habilitar/desabilitar bot√µes
    btnEncerrar.disabled = !estado.votacaoAtiva || restantes.length <= 1;
    btnReiniciar.disabled = estado.votacaoAtiva && estado.apresentados.length === 0;
  }

  // Fun√ß√µes de a√ß√£o
  async function encerrarRodada() {
    if (!confirm('Tem certeza que deseja encerrar a vota√ß√£o da rodada atual?')) {
      return;
    }
    
    try {
      const response = await fetch('/api/encerrar-rodada', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      const data = await response.json();
      
      if (data.sucesso) {
        if (data.empate) {
          // Empate detectado - a rodada foi reiniciada automaticamente
          mostrarAlerta(data.mensagem, 'warning');
        } else {
          // Vencedor definido
          mostrarAlerta(`üéâ Rodada encerrada! Vencedor: ${data.vencedor} com ${data.maxVotos} votos`, 'success');
        }
      } else {
        mostrarAlerta('Erro: ' + data.erro, 'error');
      }
    } catch (error) {
      console.error('Erro ao encerrar rodada:', error);
      mostrarAlerta('Erro de conex√£o. Tente novamente.', 'error');
    }
  }

  async function reiniciarVotacao() {
    if (!confirm('Tem certeza que deseja reiniciar toda a vota√ß√£o? Isso apagar√° todos os resultados.')) {
      return;
    }
    
    try {
      const response = await fetch('/api/reiniciar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      const data = await response.json();
      
      if (data.sucesso) {
        mostrarAlerta('üîÑ Vota√ß√£o reiniciada com sucesso!', 'success');
      } else {
        mostrarAlerta('Erro ao reiniciar vota√ß√£o', 'error');
      }
    } catch (error) {
      console.error('Erro ao reiniciar vota√ß√£o:', error);
      mostrarAlerta('Erro de conex√£o. Tente novamente.', 'error');
    }
  }

  // Eventos do Socket.IO
  socket.on('connect', () => {
    statusConexao.textContent = 'üü¢ Conectado';
    statusConexao.className = 'conectado';
  });

  socket.on('disconnect', () => {
    statusConexao.textContent = 'üî¥ Desconectado';
    statusConexao.className = 'desconectado';
  });

  socket.on('estadoAtual', (estado) => {
    atualizarInterface(estado);
  });

  socket.on('votoRegistrado', (dados) => {
    if (estadoAtual) {
      estadoAtual.votos = dados.votos;
      estadoAtual.totalVotos = dados.totalVotos;
      atualizarInterface(estadoAtual);
    }
  });

  socket.on('novaRodada', (dados) => {
    if (estadoAtual) {
      estadoAtual.rodadaAtual = dados.rodadaAtual;
      estadoAtual.votos = {};
      dados.restantes.forEach(grupo => {
        estadoAtual.votos[grupo] = 0;
      });
      estadoAtual.totalVotos = 0;
      atualizarInterface(estadoAtual);
      mostrarAlerta(`Nova rodada iniciada! Rodada ${dados.rodadaAtual}`, 'success');
    }
  });

  socket.on('votacaoFinalizada', (dados) => {
    if (estadoAtual) {
      estadoAtual.votacaoAtiva = false;
      estadoAtual.apresentados = dados.apresentados;
      atualizarInterface(estadoAtual);
      mostrarAlerta('Vota√ß√£o completamente finalizada!', 'warning');
    }
  });

  socket.on('votacaoReiniciada', (estado) => {
    atualizarInterface(estado);
    mostrarAlerta('Vota√ß√£o reiniciada com sucesso!', 'success');
  });

  socket.on('empateDetectado', (dados) => {
    if (estadoAtual) {
      // Reiniciar votos da rodada atual
      estadoAtual.votos = {};
      const restantes = estadoAtual.grupos.filter(g => !estadoAtual.apresentados.includes(g));
      restantes.forEach(grupo => {
        estadoAtual.votos[grupo] = 0;
      });
      estadoAtual.totalVotos = 0;
      atualizarInterface(estadoAtual);
      
      mostrarAlerta(`Empate detectado! ${dados.gruposEmpatados.join(', ')} com ${dados.votosEmpate} votos cada. Rodada reiniciada.`, 'warning');
    }
  });

  // Inicializa√ß√£o
  window.addEventListener('load', () => {
    console.log('Painel administrativo carregado');
  });
</script>

</body>
</html> 